<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>animation_generation_generate_animation_ – Vidigi - Auto Documentation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-ddd961a2510921635943dfbbd19534c4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="site_libs/quarto-diagram/mermaid.css" rel="stylesheet">


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Vidigi - Auto Documentation</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-modules" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Modules</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-modules">    
        <li>
    <a class="dropdown-item" href="./01_animation_facade_animate_activity_log_.html">
 <span class="dropdown-text">Animation Facade (animate_activity_log)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./02_event_log_.html">
 <span class="dropdown-text">Event Log</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./03_layout_configuration_event_position_df_.html">
 <span class="dropdown-text">Layout Configuration (event_position_df)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./04_simpy_resource_enhancement_customresource_store_populate_store_.html">
 <span class="dropdown-text">SimPy Resource Enhancement (CustomResource, Store, populate_store)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./05_snapshot_preparation_reshape_for_animations_generate_animation_df_.html">
 <span class="dropdown-text">Snapshot Preparation (reshape_for_animations / generate_animation_df)</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="./06_animation_generation_generate_animation_.html">
 <span class="dropdown-text">Animation Generation (generate_animation)</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#chapter-6-animation-generation-generate_animation" id="toc-chapter-6-animation-generation-generate_animation" class="nav-link active" data-scroll-target="#chapter-6-animation-generation-generate_animation">Chapter 6: Animation Generation (<code>generate_animation</code>)</a>
  <ul class="collapse">
  <li><a href="#the-movie-projector-turning-data-into-visuals" id="toc-the-movie-projector-turning-data-into-visuals" class="nav-link" data-scroll-target="#the-movie-projector-turning-data-into-visuals">The Movie Projector: Turning Data into Visuals</a></li>
  <li><a href="#how-to-use-generate_animation-usually-indirectly" id="toc-how-to-use-generate_animation-usually-indirectly" class="nav-link" data-scroll-target="#how-to-use-generate_animation-usually-indirectly">How to Use <code>generate_animation</code> (Usually Indirectly)</a></li>
  <li><a href="#whats-happening-under-the-hood" id="toc-whats-happening-under-the-hood" class="nav-link" data-scroll-target="#whats-happening-under-the-hood">What’s Happening Under the Hood?</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"></header>




<section id="chapter-6-animation-generation-generate_animation" class="level1">
<h1>Chapter 6: Animation Generation (<code>generate_animation</code>)</h1>
<p>Welcome to the final chapter in our <code>vidigi</code> tutorial! In <a href="./05_snapshot_preparation_reshape_for_animations_generate_animation_df_.html">Chapter 5: Snapshot Preparation (<code>reshape_for_animations</code> &amp; <code>generate_animation_df</code>)</a>, we saw how <code>vidigi</code> transforms our raw <a href="./02_event_log_.html">Event Log</a> and <a href="./03_layout_configuration_event_position_df_.html">Layout Configuration (<code>event_position_df</code>)</a> into a detailed, frame-by-frame dataset. This dataset tells us exactly where each entity (like a patient) should be on the screen, with its specific icon, at every single snapshot in time.</p>
<p>Think of the output from Chapter 5 as a perfectly prepared film reel for a movie. Each frame on the reel shows the precise position of all actors. Now, we need the <strong>movie projector</strong> to actually display this film reel as a moving picture. That’s the job of the <code>generate_animation</code> function!</p>
<section id="the-movie-projector-turning-data-into-visuals" class="level2">
<h2 class="anchored" data-anchor-id="the-movie-projector-turning-data-into-visuals">The Movie Projector: Turning Data into Visuals</h2>
<p><code>generate_animation</code> is the core rendering engine of <code>vidigi</code>. It takes the “animation-ready” DataFrame prepared in the previous step (the one with <code>minute</code>, <code>patient</code>, <code>icon</code>, <code>x_final</code>, <code>y_final</code>, etc.) and uses a powerful plotting library called Plotly Express to create the actual interactive animation.</p>
<p>Its main job is to:</p>
<ol type="1">
<li><strong>Draw Each Frame:</strong> For each time snapshot (<code>minute</code>), it plots each entity’s <code>icon</code> at its calculated <code>x_final</code> and <code>y_final</code> position.</li>
<li><strong>Create Motion:</strong> It tells Plotly how to smoothly transition the icons from their positions in one frame to their positions in the next frame. This is what makes the entities appear to move through the different stages (queues, resources).</li>
<li><strong>Add Controls &amp; Polish:</strong> It adds features like a timeline slider, play/pause buttons, tooltips (text that appears when you hover over an icon), stage labels, and optional background images.</li>
</ol>
<p>Essentially, <code>generate_animation</code> is the final artist that takes the detailed blueprint and brings it to life as an interactive animation.</p>
</section>
<section id="how-to-use-generate_animation-usually-indirectly" class="level2">
<h2 class="anchored" data-anchor-id="how-to-use-generate_animation-usually-indirectly">How to Use <code>generate_animation</code> (Usually Indirectly)</h2>
<p>Most of the time, you won’t call <code>generate_animation</code> directly. Remember the “Easy Button” from <a href="./01_animation_facade_animate_activity_log_.html">Chapter 1: Animation Facade (<code>animate_activity_log</code>)</a>? That main <code>animate_activity_log</code> function calls <code>generate_animation</code> internally as its final step.</p>
<p>However, if you wanted very fine-grained control or were building the animation step-by-step yourself, you <em>could</em> call it directly. You would first need to run the preparation steps from Chapter 5 to get the required input DataFrame.</p>
<p>Let’s imagine we have the final DataFrame from Chapter 5, called <code>animation_ready_df</code>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Assume we have this from Chapter 5 ---</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># animation_ready_df looks like this (simplified):</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">#    minute  patient icon  x_final  y_final             label  ...</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 0       0        1  '🧔🏼'     50.0    200.0          Entrance  ...</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 1       0        1  '🧔🏼'    200.0    250.0      Waiting Area  ...</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 2       5        1  '🧔🏼'    190.0    150.0    Treatment Bays  ...</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 3       5        2  '👨🏿‍🦯'    200.0    250.0      Waiting Area  ...</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># ...</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Assume we also have these from previous chapters ---</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># my_layout = pd.DataFrame(...) # From Chapter 3</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># class SimpleScenario: n_cubicles = 2</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># scenario_details = SimpleScenario() # From Chapter 1/3</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Import the function ---</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> vidigi.animation <span class="im">import</span> generate_animation</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd <span class="co"># We'll use pandas DataFrames</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Call generate_animation directly ---</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># (Normally done inside animate_activity_log)</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>final_animation <span class="op">=</span> generate_animation(</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    full_patient_df_plus_pos<span class="op">=</span>animation_ready_df, <span class="co"># The prepared data!</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    event_position_df<span class="op">=</span>my_layout,             <span class="co"># Needed for stage labels, resources</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    scenario<span class="op">=</span>scenario_details,               <span class="co"># Needed for drawing resource markers</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    plotly_height<span class="op">=</span><span class="dv">600</span>,                       <span class="co"># Set the height of the animation</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    icon_and_text_size<span class="op">=</span><span class="dv">20</span>,                   <span class="co"># Make icons smaller</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    time_display_units<span class="op">=</span><span class="st">'dhm'</span>,                <span class="co"># Show time nicely</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    frame_duration<span class="op">=</span><span class="dv">500</span>,                      <span class="co"># Slow down playback slightly</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    add_background_image<span class="op">=</span><span class="st">'floorplan.png'</span>     <span class="co"># Optional: Add a background</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="co"># You can now display the animation (e.g., in a Jupyter Notebook)</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="co"># final_animation.show()</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>What happens when you run this?</strong></p>
<p>The variable <code>final_animation</code> now holds a Plotly Figure object. If you displayed it (e.g., using <code>final_animation.show()</code> in a Jupyter notebook), you would see the complete, interactive animation:</p>
<ul>
<li>Icons (like ‘🧔🏼’ and ‘👨🏿‍🦯’) representing patients moving between locations defined in <code>my_layout</code>.</li>
<li>Smooth transitions between the time steps recorded in <code>animation_ready_df</code>.</li>
<li>A slider at the bottom showing the time (formatted as Days/Hours/Minutes).</li>
<li>Play/Pause buttons.</li>
<li>Stage labels (“Entrance”, “Waiting Area”, etc.) displayed on the chart.</li>
<li>Static markers showing the available treatment bays (based on <code>scenario_details</code>).</li>
<li>Optionally, the ‘floorplan.png’ image in the background.</li>
</ul>
</section>
<section id="whats-happening-under-the-hood" class="level2">
<h2 class="anchored" data-anchor-id="whats-happening-under-the-hood">What’s Happening Under the Hood?</h2>
<p><code>generate_animation</code> relies heavily on the <code>plotly.express.scatter</code> function. Here’s a simplified breakdown of how it works:</p>
<ol type="1">
<li><strong>Core Scatter Plot:</strong> It calls <code>px.scatter</code>, telling it:
<ul>
<li>Use <code>animation_ready_df</code> as the data source.</li>
<li>Plot points at <code>x="x_final"</code> and <code>y="y_final"</code>.</li>
<li>Use the <code>icon</code> column as the text marker for each point (<code>text="icon"</code>). This is how the emojis appear.</li>
<li>Set the <code>animation_frame</code> based on the time column (<code>minute_display</code>). This tells Plotly which rows belong to which frame of the animation.</li>
<li>Set the <code>animation_group</code> based on the <code>patient</code> column. This tells Plotly that all rows with the same <code>patient</code> ID represent the <em>same object</em> moving across frames, allowing for smooth transitions.</li>
<li>Define hover text (<code>hover_name</code>, <code>hover_data</code>) so useful information appears when you mouse over an icon.</li>
<li>Set the plot boundaries (<code>range_x</code>, <code>range_y</code>) and size (<code>height</code>, <code>width</code>).</li>
</ul></li>
<li><strong>Adding Static Layers:</strong> After creating the basic animated scatter plot, <code>generate_animation</code> adds extra, non-moving layers:
<ul>
<li><strong>Stage Labels:</strong> If <code>display_stage_labels=True</code>, it adds another <code>go.Scatter</code> trace (this time non-animated) to display the text labels from the <code>event_position_df</code> at their respective (x, y) coordinates.</li>
<li><strong>Resource Markers:</strong> If a <code>scenario</code> object is provided, it calculates the positions for each individual resource slot (like each treatment bay) based on the <code>event_position_df</code> and the resource counts in <code>scenario</code>. It then adds <em>another</em> static <code>go.Scatter</code> trace to draw markers (like light blue circles or custom icons) at these positions.</li>
<li><strong>Background Image:</strong> If <code>add_background_image</code> is specified, it uses <code>fig.add_layout_image</code> to place the image underneath the animation layers.</li>
</ul></li>
<li><strong>Styling and Controls:</strong> Finally, it adjusts the appearance:
<ul>
<li>Sets the size of the icon/text markers (<code>icon_and_text_size</code>).</li>
<li>Hides axes and gridlines (unless <code>setup_mode=True</code>).</li>
<li>Configures the animation player (play button, slider speed using <code>frame_duration</code> and <code>frame_transition_duration</code>).</li>
<li>Returns the complete Plotly <code>Figure</code> object.</li>
</ul></li>
</ol>
<p>Here’s a simplified view of the process:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">sequenceDiagram
    participant AAL as animate_activity_log (Optional Caller)
    participant GA as generate_animation (The Projector)
    participant Data as animation_ready_df (The Film Reel)
    participant Layout as event_position_df (Stage Map)
    participant Scenario as scenario object (Resource Info)
    participant PX as Plotly Express
    participant PlotlyFig as Plotly Figure (The Movie)

    AAL-&gt;&gt;GA: Call with Data, Layout, Scenario, Options
    GA-&gt;&gt;PX: px.scatter(data=Data, x='x_final', y='y_final', text='icon', animation_frame='minute_display', animation_group='patient', ...)
    PX--&gt;&gt;GA: Return basic animated figure (fig)
    GA-&gt;&gt;Layout: Get stage label positions
    GA-&gt;&gt;PlotlyFig: fig.add_trace(go.Scatter(...)) # Add stage labels
    alt Scenario provided
        GA-&gt;&gt;Layout: Get resource base positions &amp; names
        GA-&gt;&gt;Scenario: Get resource counts
        GA-&gt;&gt;PlotlyFig: fig.add_trace(go.Scatter(...)) # Add resource markers
    end
    opt Background image provided
        GA-&gt;&gt;PlotlyFig: fig.add_layout_image(...) # Add background
    end
    GA-&gt;&gt;PlotlyFig: Update layout, styles, animation speed
    GA--&gt;&gt;AAL: Return final Plotly Figure
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p><strong>Code Dive (Simplified):</strong></p>
<p>Looking inside the <code>vidigi/animation.py</code> file, the heart of <code>generate_animation</code> is the <code>plotly.express.scatter</code> call:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simplified from vidigi/animation.py</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ... other imports</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_animation(full_patient_df_plus_pos, event_position_df, scenario<span class="op">=</span><span class="va">None</span>, ...):</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ... (setup code for time display, plot boundaries) ...</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Core Animation Creation ===</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> px.scatter(</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>            full_patient_df_plus_pos.sort_values(<span class="st">'minute'</span>), <span class="co"># Use the prepared data</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>            x<span class="op">=</span><span class="st">"x_final"</span>,            <span class="co"># Horizontal position from data</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>            y<span class="op">=</span><span class="st">"y_final"</span>,            <span class="co"># Vertical position from data</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>            animation_frame<span class="op">=</span><span class="st">"minute_display"</span>, <span class="co"># Column defining animation time steps</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>            animation_group<span class="op">=</span><span class="st">"patient"</span>,  <span class="co"># Column identifying entities across frames</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>            text<span class="op">=</span><span class="st">"icon"</span>,            <span class="co"># Column with the emoji/text to display</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>            hover_name<span class="op">=</span><span class="st">"event"</span>,     <span class="co"># Show event name on hover</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>            hover_data<span class="op">=</span>[<span class="st">"patient"</span>, <span class="st">"time"</span>, <span class="st">"resource_id"</span>], <span class="co"># Show other details</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>            <span class="co"># ... (ranges, height, width) ...</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>            opacity<span class="op">=</span><span class="dv">0</span> <span class="co"># Make the actual scatter points invisible (we only see the text)</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Add Stage Labels (if requested) ===</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> display_stage_labels:</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        fig.add_trace(go.Scatter(</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>            x<span class="op">=</span>event_position_df[<span class="st">'x'</span>] <span class="op">+</span> <span class="dv">10</span>, <span class="co"># Offset slightly</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>            y<span class="op">=</span>event_position_df[<span class="st">'y'</span>],</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>            mode<span class="op">=</span><span class="st">"text"</span>, <span class="co"># Display text, not points</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>            text<span class="op">=</span>event_position_df[<span class="st">'label'</span>], <span class="co"># Get labels from layout</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>            <span class="co"># ... (styling) ...</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>            hoverinfo<span class="op">=</span><span class="st">'none'</span> <span class="co"># Don't show hover info for labels</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Add Resource Markers (if scenario provided) ===</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> scenario <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ... (code to calculate positions for each resource instance) ...</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># events_with_resources = calculate_resource_positions(...)</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>        fig.add_trace(go.Scatter(</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>            x<span class="op">=</span>events_with_resources[<span class="st">'x_final'</span>], <span class="co"># Calculated X for each resource spot</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>            y<span class="op">=</span>events_with_resources[<span class="st">'y_final'</span>] <span class="op">-</span> <span class="dv">10</span>, <span class="co"># Place slightly below entity Y</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>            mode<span class="op">=</span><span class="st">"markers"</span>, <span class="co"># Draw markers (e.g., circles)</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>            marker<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'LightSkyBlue'</span>, size<span class="op">=</span><span class="dv">15</span>),</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>            opacity<span class="op">=</span>resource_opacity,</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>            hoverinfo<span class="op">=</span><span class="st">'none'</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (Or use 'mode="markers+text"' if using custom_resource_icon)</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Add Background Image (if requested) ===</span></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> add_background_image <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>        fig.add_layout_image(</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>            <span class="co"># ... (configuration for image source, position, opacity) ...</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Final Styling and Controls ===</span></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>    fig.update_traces(textfont_size<span class="op">=</span>icon_and_text_size) <span class="co"># Set icon size</span></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>    fig.update_xaxes(showticklabels<span class="op">=</span><span class="va">False</span>, showgrid<span class="op">=</span><span class="va">False</span>) <span class="co"># Clean up axes</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>    fig.update_yaxes(showticklabels<span class="op">=</span><span class="va">False</span>, showgrid<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ... (configure animation speed, play button etc.) ...</span></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This simplified view shows how <code>generate_animation</code> layers the different visual elements (animated entities, static labels, static resource markers, background) using Plotly’s capabilities to produce the final interactive figure.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>You’ve reached the end of the <code>vidigi</code> core concepts tutorial! We’ve seen how <code>generate_animation</code> acts as the final “movie projector”. It takes the meticulously prepared frame-by-frame data (the output of <code>generate_animation_df</code> from <a href="./05_snapshot_preparation_reshape_for_animations_generate_animation_df_.html">Chapter 5: Snapshot Preparation (<code>reshape_for_animations</code> &amp; <code>generate_animation_df</code>)</a>) and uses Plotly Express to render the interactive animation. It plots entities, handles smooth transitions, adds labels, resource markers, and controls, bringing your process simulation to life visually.</p>
<p>While often called behind the scenes by the main <a href="./01_animation_facade_animate_activity_log_.html"><code>animate_activity_log</code></a> function, understanding <code>generate_animation</code> shows you how the final visualization is constructed.</p>
<p>You now have a complete picture of the <code>vidigi</code> pipeline: 1. Starting with an <a href="./02_event_log_.html">Event Log</a> (the script) and a <a href="./03_layout_configuration_event_position_df_.html">Layout Configuration (<code>event_position_df</code>)</a> (the map). 2. Ensuring resources are uniquely identified using the pattern from <a href="04_simpy_resource_enhancement___customresource____store____populate_store___.qmd">Chapter 4: Simpy Resource Enhancement (<code>CustomResource</code>, <code>Store</code>, <code>populate_store</code>)</a>. 3. Preparing frame-by-frame snapshot data using the functions covered in <a href="./05_snapshot_preparation_reshape_for_animations_generate_animation_df_.html">Chapter 5: Snapshot Preparation (<code>reshape_for_animations</code> &amp; <code>generate_animation_df</code>)</a>. 4. Finally, rendering the animation with <code>generate_animation</code> (this chapter), often orchestrated by the main <a href="./01_animation_facade_animate_activity_log_.html"><code>animate_activity_log</code></a> facade.</p>
<p>Congratulations! You’re now equipped with the knowledge to understand and use <code>vidigi</code> to create insightful animations of your own processes. Happy visualizing!</p>
<hr>
<p>Generated by <a href="https://github.com/The-Pocket/Tutorial-Codebase-Knowledge">AI Codebase Knowledge Builder</a></p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>